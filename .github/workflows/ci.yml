name: CI

on:
    pull_request:
    push:
        branches: ["main"]

concurrency:
    group: ci-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    quality-and-tests:
        name: Lint / Typecheck / Test
        runs-on: ubuntu-latest
        timeout-minutes: 10

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11.8"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Ruff format (check only)
              run: ruff format --check .

            - name: Ruff lint
              run: ruff check .

            - name: Mypy (strict)
              run: mypy app

            - name: Pytest (with reports)
              run: |
                  pytest -q \
                    --junitxml=junit.xml \
                    --cov=app --cov-report=xml:coverage.xml

            - name: Upload test report
              uses: actions/upload-artifact@v4
              with:
                  name: junit
                  path: junit.xml

            - name: Upload coverage report
              uses: actions/upload-artifact@v4
              with:
                  name: coverage
                  path: coverage.xml

    dependency-audit:
        name: Dependency Vulnerability Scan
        runs-on: ubuntu-latest
        timeout-minutes: 10
        permissions:
            contents: read

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11.8"
                  cache: "pip"

            - name: Install deps for audit
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: pip-audit (third-party deps only)
              run: |
                  python -m pip freeze --exclude-editable > requirements-audit.txt
                  pip-audit -r requirements-audit.txt --strict

    codeql:
        name: CodeQL (SAST)
        runs-on: ubuntu-latest
        timeout-minutes: 15
        permissions:
            actions: read
            contents: read
            security-events: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: python

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            - name: Analyze
              uses: github/codeql-action/analyze@v3
